<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->



<!-- Mutation, paper-spinner, firebase collection finished, dom repeat finished, dom ready  -->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="advanced-charts">
  <template>
    <style>
      :host {
        display: block;
      }

      google-chart {
        height: 500px;
        width: auto;
      }
      #inputs {
        @apply(--layout-horizontal);
        @apply(--layout-around-justified);
        @apply(--layout-center);
        padding: 10px;
      }
      paper-button {
        background-color: var(--default-primary-color);
        color: var(--text-primary-color);
      }
    </style>
    <firebase-collection id="fbColl"
      order-by-child="{{orderBy}}"
      location="{{ref}}"
      data="{{dataPoints}}"
      on-firebase-value="aggregation"></firebase-collection>

    <paper-material elevation="1">
      <h2>States</h2>
      <google-chart
        type="{{chartType}}"
        id='selection-chart'
        cols='[{"label":"Type", "type":"string"}, {"label":"Number", "type":"number"}]'
        rows="{{parser}}"
        options="{{chosenOption}}">
      </google-chart>
<!-- <h1>{{parser}}</h1> -->
      <div id="inputs">
        <paper-input label="Data Node" value="{{firebaseNode}}"></paper-input>
        <paper-input label="Equal To" value="{{orderBy}}"></paper-input>
        <paper-button raised on-tap="buildChart">Build Chart <iron-icon icon="arrow-forward"></iron-icon></paper-button>
        <paper-button raised on-tap="makePie">PIE <iron-icon icon="arrow-forward"></iron-icon></paper-button>
        <paper-button raised on-tap="makeBar">BAR <iron-icon icon="arrow-forward"></iron-icon></paper-button>
        <paper-button raised on-tap="makeGeo">GEO <iron-icon icon="arrow-forward"></iron-icon></paper-button>
      </div>
    </paper-material>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'advanced-charts',

      properties: {
        baseRef: {
          type: String,
          value: '',
          notify: true
        },
        parser: {
          type: Object,
          value: '',
          notify: true
        },
        chosenOption: {
          type: Object,
          value: '',
          notify: true
        },
        ref: {
          type: String,
          value: '',
          notify: true
        },
         dataPoints: {
           type: Object,
         },
        chartType: {
          type: String,
          value: 'pie',
          notify: true
        },
        chartData: {
          type: Object,
          notify: true
        },
        orderBy: {
          type: String,
          value: 'STABBR',
          notify: true
        },
        equalTo: {
          type: String,
          value: '100654',
          notify: true
        },
        firebaseNode: {
          type: String,
          value: 'institutions',
          notify: true
        },
        chartOptions: {
          type: Object,
          value: {
            'pie': {
              "pieSliceBorderColor": "none",
              "backgroundColor": "none",
              "pieSliceText": "none"
            },
            'bar': {
              "backgroundColor": "none"
              // bar options
            },
            'column': {
              "backgroundColor": "none"
              // bar options
            },
            'geo': {
              "region": "US", "resolution": "provinces", "colorAxis": {"colors": ["grey", "#f90", "#f00"]},
              "backgroundColor": "none",
              "datalessRegionColor": "#ddd",
              "defaultColor": "#f5f5f5"
            }
          },
          notify: true
        }
      },

      buildRef: function(baseRef) {
        return baseRef + this.firebaseNode //TODO: account for people not putting trailing or beginning slashes. Also, account for data coming from REST/API calls
      },
      buildChartData: function(e) {

      },

      aggregation: function(e) {
        var category = this.orderBy
        var FBR = this.dataPoints;
        var aggResult = [];
        var currentItem = '';
        var aggIndex = 0;
        var parser = [];

        for (var i = 0; i < FBR.length; i++) {
          if (!currentItem) {
            aggResult.push({type:FBR[i][category], number:1}); 
            currentItem = FBR[i][category];
          }
          else if (currentItem === FBR[i][category]) {
            aggResult[aggIndex]["number"]++;
            currentItem = FBR[i][category];
          }
          else {
            aggResult.push({type:FBR[i][category], number:1});
            currentItem = FBR[i][category];
            aggIndex++;
            parser.push([aggResult[aggIndex - 1]["type"], aggResult[aggIndex - 1]["number"]])
          }
        }
        parser.push([aggResult[aggIndex]["type"], aggResult[aggIndex]["number"]])
        // console.log(aggResult);
        //var chartType
       
        this.chosenOption = this.chartOptions[this.chartType];

         console.log(this.chartOptions.pie);
        // var chart = document.querySelector('#selection-chart');
        // chart.drawChart();
        
        this.parser = parser;
      },

      makePie: function() {
        this.chartType = "pie";
        this.chosenOption = this.chartOptions[this.chartType];
        var chart = document.querySelector('#selection-chart');
        chart.drawChart();
      },

      makeBar: function() {
        this.chartType = "column";
        this.chosenOption = this.chartOptions[this.chartType];
        var chart = document.querySelector('#selection-chart');
        chart.drawChart();
      },

      makeGeo: function() {
        this.chartType = "geo";
        this.chosenOption = this.chartOptions[this.chartType];
        var chart = document.querySelector('#selection-chart');
        chart.drawChart();
      },

      buildChart: function() {
        this.ref = this.buildRef(this.baseRef)
        this.chartData = this.data;
      }
    });
  })();
  </script>
</dom-module>
