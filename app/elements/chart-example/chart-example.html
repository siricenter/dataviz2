<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->



<!-- Mutation, paper-spinner, firebase collection finished, dom repeat finished, dom ready  -->

<!-- *****************************************************************************
*
*                                   EXCUSE MY MESS!!
*                     I am currently working on another aspect of this
*           element. There will be A LOT of crazy monster code that does nothing.
*                        apologies in advance for the following...
*
********************************************************************************-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="chart-example">
  <template>
    <style>
      :host {
        display: block;
      }

      google-chart {
        height: 500px;
        width: auto;
      }
      #inputs {
        @apply(--layout-horizontal);
        @apply(--layout-around-justified);
        @apply(--layout-center);
        padding: 10px;
      }
      paper-button {
        background-color: var(--default-primary-color);
        color: var(--text-primary-color);
      }
    </style>
    <firebase-collection id="fbExp"
      location="{{expRef}}"
      order-by-child="{{orderBy}}"
      equal-to="{{equalTo}}"
      data="{{expData}}"
      on-firebase-value="buildChartData"></firebase-collection>

     <firebase-collection id="fbGrad"
      location="{{gradRef}}"
      order-by-child="{{orderBy}}"
      equal-to="{{equalTo}}"
      start-at="{{startAt}}"
      end-at="{{endAt}}"
      data="{{gradData}}"
     on-firebase-value="buildChartData"></firebase-collection>

      <firebase-collection id="fbInst"
      location="{{instRef}}"
      order-by-child="{{orderBy}}"
      equal-to="{{equalTo}}"
      data="{{instData}}"
      on-firebase-value="buildChartData"></firebase-collection>

    <paper-material elevation="1">
      <h2>Data Visualization</h2>
      <h2>I am here!</h2>
       <h2>{{chosenvalue}}</h2>
      <google-chart
        type="{{chartType}}"
        id='selection-chart'
        cols='[{"label":"Type", "type":"string"}, {"label":"Number", "type":"number"}]'
        rows="{{parser}}"
        options="{{chosenOption}}">
      </google-chart>
<!-- <h1>{{parser}}</h1> -->
      <div id="inputs">
        <paper-input label="Data Node" value="{{firebaseNode}}"></paper-input>
        <paper-input label="Equal To" value="{{orderBy}}"></paper-input>
        <paper-button raised on-tap="buildChartData">Build Chart <iron-icon icon="arrow-forward"></iron-icon></paper-button>
        <paper-button raised on-tap="makePie">PIE <iron-icon icon="arrow-forward"></iron-icon></paper-button>
        <paper-button raised on-tap="makeBar">BAR <iron-icon icon="arrow-forward"></iron-icon></paper-button>
        <paper-button raised on-tap="makeGeo">GEO <iron-icon icon="arrow-forward"></iron-icon></paper-button>
      </div>
    </paper-material>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'chart-example',

      properties: {
        chosenvalue: {
          type: Array,
          value: [{value: "Please select from one of the lists above"}]
          
        },
        baseRef: {
          type: String,
          value: '',
          notify: true
        },
        parser: {
          type: Object,
          value: '',
          notify: true
        },
        chosenOption: {
          type: Object,
          value: '',
          notify: true
        },
        ref: {
          type: String,
          value: '',
          notify: true
        },
        gradRef: {
          type: String,
          value: '',
          notify: true
        },
        instRef: {
          type: String,
          value: '',
          notify: true
        },
        expRef: {
          type: String,
          value: '',
          notify: true
        },
        fbExpData: {
           type: Object,
           value:'',
           notify: true
         },
        fbGradData: {
            type: Object,
           value:'',
           notify: true
         },
        fbInstData: {
            type: Object,
           value:'',
           notify: true
         },

        chartType: {
          type: String,
          value: 'pie',
          notify: true
        },
        chartData: {
          type: Object,
          notify: true
        },
        orderBy: {
          type: String,
          value: 'UNITID',
          notify: true
        },
        startAt: {
          type: Number,
          value: null,
          notify: true
        },
        endAt: {
          type: Number,
          value: null,
          notify: true
        },
        equalTo: {
          type: String,
          value: null,
          notify: true
        },
        firebaseNode: {
          type: String,
          value: 'expenditures',
          notify: true
        },
        chartOptions: {
          type: Object,
          value: {
            'pie': {
              "pieSliceBorderColor": "none",
              "backgroundColor": "none",
              "pieSliceText": "none"
            },
            'bar': {
              "backgroundColor": "none"
              // bar options
            },
            'column': {
              "backgroundColor": "none"
              // bar options
            },
            'geo': {
              "region": "US", "resolution": "provinces", "colorAxis": {"colors": ["grey", "#f90", "#f00"]},
              "backgroundColor": "none",
              "datalessRegionColor": "#ddd",
              "defaultColor": "#f5f5f5"
            }
          },
          notify: true
        }
      },
        //array.slice(indexOf(some sub property of where its 3))
      gradSnap: function(dropDownItem) {
        var category = this.orderBy;
        var FBR = this.fbGradData;
        var grad2 = [];
        var grad3 = [];
        var renderedData = [];
        var dividedData = 0;

        console.log(FBR);
      //take the object, add new property gradrate, then push whole object.
      var pos = FBR.map(function(e) { return e.GRTYPE; }).indexOf('3');
      grad2 = FBR.slice(0, pos);
      grad3 = FBR.slice(pos);
      for (var i = 0; i < grad3.length; i++) {
        dividedData = grad3[i]["GRTOTLT"] / grad2[i]["GRTOTLT"];
        dividedData = dividedData.toFixed(4);
        dividedData = dividedData * 1;
        FBR[i].GRADRATE = dividedData;
        //FBR[i].push()
      }
      
        renderedData = this.aggregationBasic(FBR)
    
      console.log(FBR);
      return renderedData;
      },

      instSnap: function(dropDownItem) {
        var category = this.orderBy;
        var FBR = this.fbInstData;
        var renderedData = [];

        console.log("instSnap being called");
        //finding all of the data of the given firebase collection, and filling an array based on specific data chosen by the user.
        //renderedData = this.aggregationBasic(FBR);


      },

      expSnap: function(dropDownItem) {
        console.log("hitting expSnap");
        var FBR = this.fbExpData;
        var renderedData = [];
        console.log("expSnap being called");
        //renderedData = this.aggregationBasic(FBR);
        

      },

      //a function needs to be called after all three of these functions are done running, and parse the information into an object that will be given to the google chart element.
      
      buildChartData: function(e) {
        // Build chart data will be somewhat of a 'main' function for parsing all of the information into a string to be presented to the google chart builder.
        var finalData = [];
        var parser = [];
        var dataPoint = '';
        var stringifiedData = '';
        var chosenValue = [];
        chosenValue = this.chosenValue;
        var name = this.chosenvalue[1].value;
        var xData = this.chosenvalue[2].value;
        var yData = this.chosenvalue[3].value;
        var color = this.chosenvalue[4].value;
        finalData.push([]);

        for(var i = 1; i < this.chosenvalue.length; i++) {
          finalData[0].push(this.chosenvalue[i].value);
        }

        console.log("here are the expRates");
        console.log(this.fbExpData);


        //loop through each of the dropdowns on the page and find out which 'snap' function to call.
        //var dataPoint = whatever the dropdown says
        for(var i = 1; i < this.chosenvalue.length; i++) {

          dataPoint = this.chosenvalue[i].value;
          
          if(this.chosenvalue[i].chart === "grad") {

            parser = this.gradSnap(dataPoint);
            //finalData[i].push(parser);

            }
          else if(this.chosenvalue[i].chart === "exp") {
            parser = this.expSnap(dataPoint);
            //finalData[i].push(parser);

            }
          else {
            parser = this.instSnap(dataPoint);
            //finalData[i].push(parser);

          }
        }
      },

      aggregation: function() {

        console.log("WORKING");
        //this fuction will figure out how many values need to be aggregated, and calls the appropriate function

      },

      //THIS IS THE WORKING CODE TO MAKE THE BASIC CHARTS. basic aggregation, one value.
      aggregationBasic: function(FBR) {

        console.log("inside the aggregator");
        var category = this.orderBy
        var FBR = this.fbGradData;
        var aggResult = [];
        var currentItem = '';
        var aggIndex = 0;
        var parser = [];

        // for (var i = 0; i < FBR.length; i++) {
        //   if (!currentItem) {
        //     aggResult.push({type:FBR[i][category], number:1}); 
        //     currentItem = FBR[i][category];
        //   }
        //   else if (currentItem === FBR[i][category]) {
        //     aggResult[aggIndex]["number"]++;
        //     currentItem = FBR[i][category];
        //   }
        //   else {
        //     aggResult.push({type:FBR[i][category], number:1});
        //     currentItem = FBR[i][category];
        //     parser.push([aggResult[aggIndex]["type"], aggResult[aggIndex]["number"]]);
        //     aggIndex++;
        //   }
        // }
        // console.log(aggResult);
        // parser.push([aggResult[aggIndex]["type"], aggResult[aggIndex]["number"]]);
        // // 
        // //var chartType
       
        // this.chosenOption = this.chartOptions[this.chartType];

        // //sortArrOfObjectsByParam(FBR, "STABBR");



         console.log(FBR);
        // var chart = document.querySelector('#selection-chart');
        // chart.drawChart();
        
        this.parser = parser;

        return parser
      },

      sortArrOfObjectsByParam: function(arrToSort, strObjParamToSortBy , sortAscending) {
      if(sortAscending == undefined){ sortAscending = true;}  // default to true
    
      if(sortAscending) {
        arrToSort.sort(function (a, b) {
          return a[strObjParamToSortBy] > b[strObjParamToSortBy];
        });
      }
      else {
        arrToSort.sort(function (a, b) {
            return a[strObjParamToSortBy] < b[strObjParamToSortBy];
        });
      }
    },

      //Name: institutions=>STABBR, X: expenditures=>total, Y: gradRates=>, Color: institutions=>YEAR, Size: expenditures=>TOTAL  

      aggregationAdvanced: function(FBR) {

        console.log("inside the aggregator");
        var category = this.orderBy
        
        var aggResult = [];
        var currentItem = '';
        var aggIndex = 0;
        var parser = [];

        for (var i = 0; i < FBR.length; i++) {
         
          

        }
        console.log(aggResult);
        parser.push([aggResult[aggIndex]["type"], aggResult[aggIndex]["number"]]);
        // 
        //var chartType
       
        this.chosenOption = this.chartOptions[this.chartType];

        //sortArrOfObjectsByParam(FBR, "STABBR");



         console.log(FBR);
        // var chart = document.querySelector('#selection-chart');
        // chart.drawChart();
        
        this.parser = parser;

        return parser;



        // var chosenValue = [];
        // chosenValue = this.chosenValue;
        // var name = this.chosenvalue[1].value;
        // var xData = this.chosenvalue[2].value;
        // var yData = this.chosenvalue[3].value;
        // var color = this.chosenvalue[4].value;
        // var FBR = this.dataPoints;
        // var aggResult = [];
        // var currentItem = '';
        // var aggIndex = 0;
        // var parser = [];

        // console.log(this.chosenvalue[1].type + " " + this.chosenvalue[1].value);
        // console.log("X " + this.chosenvalue[2].value);
        // console.log("Y " + this.chosenvalue[3].value);
        // console.log("category " + this.chosenvalue[4].value);
        

        // for (var i = 0; i < FBR.length; i++) {
        //   if (!currentItem) {
        //     aggResult.push({title:FBR[i][name], xData:FBR[i][xData], yData:FBR[i][yData], color:color, size:1}); 
        //     currentItem = FBR[i][category];
        //   }
        //   else if (currentItem === FBR[i][category]) {
        //     aggResult[aggIndex]["size"]++;
        //     currentItem = FBR[i][category];
        //   }
        //   else {
        //     aggResult.push({title:FBR[i][name], xData:FBR[i][xData], yData:FBR[i][yData], color:color, size:1}); 
        //     currentItem = FBR[i][category];
        //     parser.push([ aggResult[aggIndex]["name"], 
        //                   aggResult[aggIndex]["xData"], 
        //                   aggResult[aggIndex]["yData"], 
        //                   aggResult[aggIndex]["color"],
        //                   aggResult[aggIndex]["size"] ])
        //     aggIndex++;
        //   }
        // }
        // parser.push([ aggResult[aggIndex]["name"], 
        //               aggResult[aggIndex]["xData"], 
        //               aggResult[aggIndex]["yData"], 
        //               aggResult[aggIndex]["color"],
        //               aggResult[aggIndex]["size"] ])

        // this.chosenOption = this.chartOptions[this.chartType];
        // console.log(this.chartOptions.pie);
        // this.parser = parser;

      },


      // could be more efficient
      makePie: function() {
        this.chartType = "bubble";
        this.chosenOption = this.chartOptions[this.chartType];
        var chart = document.querySelector('#selection-chart');
        chart.drawChart();
      },

      makeBar: function() {
        this.chartType = "column";
        this.chosenOption = this.chartOptions[this.chartType];
        var chart = document.querySelector('#selection-chart');
        chart.drawChart();
      },

      makeGeo: function() {
        this.chartType = "geo";
        this.chosenOption = this.chartOptions[this.chartType];
        var chart = document.querySelector('#selection-chart');
        chart.drawChart();
      },

      buildRef: function(baseRef) {
        return baseRef + this.firebaseNode //TODO: account for people not putting trailing or beginning slashes. Also, account for data coming from REST/API calls
      },

      buildChart: function() {  //Some Hardcoded information, need to change as soon as possible
        this.instRef = this.buildRef(this.baseRef);
         this.firebaseNode = 'expenditures'
       this.expRef = this.buildRef(this.baseRef);
         this.firebaseNode = 'gradRates'
         this.gradRef = this.buildRef(this.baseRef);
        this.chartData = this.data;
      }
    });
  })();
  </script>
</dom-module>
