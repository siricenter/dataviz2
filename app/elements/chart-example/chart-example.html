<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->



<!-- Mutation, paper-spinner, firebase collection finished, dom repeat finished, dom ready  -->

<!-- *****************************************************************************
*
*                                   EXCUSE MY MESS!!
*                     I am currently working on another aspect of this
*           element. There will be A LOT of crazy monster code that does nothing.
*                        apologies in advance for the following...
*
********************************************************************************-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="chart-example">
  <template>
    <style>
      :host {
        display: block;
      }

      google-chart {
        height: 500px;
        width: auto;
      }
      #inputs {
        @apply(--layout-horizontal);
        @apply(--layout-around-justified);
        @apply(--layout-center);
        padding: 10px;
      }
      paper-button {
        background-color: var(--default-primary-color);
        color: var(--text-primary-color);
      }
    </style>
    <!-- <firebase-collection id="fbExp"
      location="{{ref}}"
      order-by-child="UNITID"
      equal-to="{{equalTo}}"
      start-at="{{startAt}}"
      end-at="{{endAt}}"
      data="{{expData}}"
      on-firebase-value="gradSnap"></firebase-collection> -->

     <!--  <firebase-collection id="fbGrad"
      location="{{gradRef}}"
      order-by-child="UNITID"
      equal-to="{{equalTo}}"
      start-at="{{startAt}}"
      end-at="{{endAt}}"
      data="{{gradData}}"
     on-firebase-value="gradSnap"></firebase-collection> -->

      <firebase-collection id="fbInst"
      location="{{instRef}}"
      order-by-child="{{orderBy}}"
      equal-to="{{equalTo}}"
      data="{{instData}}"
      on-firebase-value="aggregationBasic"></firebase-collection>

    <paper-material elevation="1">
      <h2>States</h2>
      <google-chart
        type="{{chartType}}"
        id='selection-chart'
        cols='[{"label":"Type", "type":"string"}, {"label":"Number", "type":"number"}]'
        rows="{{parser}}"
        options="{{chosenOption}}">
      </google-chart>
<!-- <h1>{{parser}}</h1> -->
      <div id="inputs">
        <paper-input label="Data Node" value="{{firebaseNode}}"></paper-input>
        <paper-input label="Equal To" value="{{orderBy}}"></paper-input>
        <paper-button raised on-tap="buildChart">Build Chart <iron-icon icon="arrow-forward"></iron-icon></paper-button>
        <paper-button raised on-tap="makePie">PIE <iron-icon icon="arrow-forward"></iron-icon></paper-button>
        <paper-button raised on-tap="makeBar">BAR <iron-icon icon="arrow-forward"></iron-icon></paper-button>
        <paper-button raised on-tap="makeGeo">GEO <iron-icon icon="arrow-forward"></iron-icon></paper-button>
      </div>
    </paper-material>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'chart-example',

      properties: {
        baseRef: {
          type: String,
          value: '',
          notify: true
        },
        parser: {
          type: Object,
          value: '',
          notify: true
        },
        chosenOption: {
          type: Object,
          value: '',
          notify: true
        },
        ref: {
          type: String,
          value: '',
          notify: true
        },
        gradRef: {
          type: String,
          value: '',
          notify: true
        },
        instRef: {
          type: String,
          value: '',
          notify: true
        },
        expRef: {
          type: String,
          value: '',
          notify: true
        },
        expData: {
           type: Object,
         },
        gradData: {
           type: Object,
         },
        instData: {
           type: Object,
         },
        chartType: {
          type: String,
          value: 'pie',
          notify: true
        },
        chartData: {
          type: Object,
          notify: true
        },
        orderBy: {
          type: String,
          value: 'STABBR',
          notify: true
        },
        startAt: {
          type: Number,
          value: '2',
          notify: true
        },
        endAt: {
          type: Number,
          value: '3',
          notify: true
        },
        equalTo: {
          type: String,
          value: null,
          notify: true
        },
        firebaseNode: {
          type: String,
          value: 'institutions',
          notify: true
        },
        chartOptions: {
          type: Object,
          value: {
            'pie': {
              "pieSliceBorderColor": "none",
              "backgroundColor": "none",
              "pieSliceText": "none"
            },
            'bar': {
              "backgroundColor": "none"
              // bar options
            },
            'column': {
              "backgroundColor": "none"
              // bar options
            },
            'geo': {
              "region": "US", "resolution": "provinces", "colorAxis": {"colors": ["grey", "#f90", "#f00"]},
              "backgroundColor": "none",
              "datalessRegionColor": "#ddd",
              "defaultColor": "#f5f5f5"
            }
          },
          notify: true
        }
      },
        //array.slice(indexOf(some sub property of where its 3))
      gradSnap: function() {
        var category = this.orderBy;
        var FBR = this.instData;
        var grad2 = [];
        var grad3 = [];
        var renderedData = [];
        var dividedData = 0;

        console.log("working");
      //take the object, add new property gradrate, then push whole object.
      var pos = FBR.map(function(e) { return e.GRTYPE; }).indexOf('3');
      grad2 = FBR.slice(0, pos);
      grad3 = FBR.slice(pos);
      for (var i = 0; i < grad3.length; i++) {
        dividedData = grad3[i]["GRTOTLT"] / grad2[i]["GRTOTLT"];
        dividedData = dividedData.toFixed(4);
        dividedData = dividedData * 1;
        FBR[i].GRADRATE = dividedData;
        //FBR[i].push()
      }
      console.log(FBR);
      },

      
      buildChartData: function(e) {


      },

      aggregation: function() {

        console.log("WORKING");
        //this fuction will figure out how many values need to be aggregated, and calls the appropriate function

      },

      //THIS IS THE WORKING CODE TO MAKE THE BASIC CHARTS. basic aggregation, one value.
      aggregationBasic: function(e) {
        var category = this.orderBy
        var FBR = this.instData;
        var aggResult = [];
        var currentItem = '';
        var aggIndex = 0;
        var parser = [];

        for (var i = 0; i < FBR.length; i++) {
          if (!currentItem) {
            aggResult.push({type:FBR[i][category], number:1}); 
            currentItem = FBR[i][category];
          }
          else if (currentItem === FBR[i][category]) {
            aggResult[aggIndex]["number"]++;
            currentItem = FBR[i][category];
          }
          else {
            aggResult.push({type:FBR[i][category], number:1});
            currentItem = FBR[i][category];
            parser.push([aggResult[aggIndex]["type"], aggResult[aggIndex]["number"]]);
            aggIndex++;
          }
        }
        parser.push([aggResult[aggIndex]["type"], aggResult[aggIndex]["number"]]);
        // console.log(aggResult);
        //var chartType
       
        this.chosenOption = this.chartOptions[this.chartType];

         console.log(this.chartOptions.pie);
        // var chart = document.querySelector('#selection-chart');
        // chart.drawChart();
        
        this.parser = parser;
      },

      //Name: institutions=>STABBR, X: expenditures=>total, Y: gradRates=>, Color: institutions=>YEAR, Size: expenditures=>TOTAL  

      aggregationAdvanced: function(e) {
        var xData = '';
        var yData = '';
        var name = '';
        var FBR = this.dataPoints;
        var aggResult = [];
        var currentItem = '';
        var aggIndex = 0;
        var parser = [];

        for (var i = 0; i < FBR.length; i++) {
          if (!currentItem) {
            aggResult.push({title:FBR[i][name], xData:FBR[i][xData], yData:FBR[i][yData], color:color, size:1}); 
            currentItem = FBR[i][category];
          }
          else if (currentItem === FBR[i][category]) {
            aggResult[aggIndex]["size"]++;
            currentItem = FBR[i][category];
          }
          else {
            aggResult.push({title:FBR[i][name], xData:FBR[i][xData], yData:FBR[i][yData], color:color, size:1}); 
            currentItem = FBR[i][category];
            parser.push([ aggResult[aggIndex]["name"], 
                          aggResult[aggIndex]["xData"], 
                          aggResult[aggIndex]["yData"], 
                          aggResult[aggIndex]["color"],
                          aggResult[aggIndex]["size"] ])
            aggIndex++;
          }
        }
        parser.push([ aggResult[aggIndex]["name"], 
                      aggResult[aggIndex]["xData"], 
                      aggResult[aggIndex]["yData"], 
                      aggResult[aggIndex]["color"],
                      aggResult[aggIndex]["size"] ])
        // console.log(aggResult);
        //var chartType


       
        this.chosenOption = this.chartOptions[this.chartType];

         console.log(this.chartOptions.pie);
        // var chart = document.querySelector('#selection-chart');
        // chart.drawChart();
        
        this.parser = parser;
      },


      // could be more efficient
      makePie: function() {
        this.chartType = "pie";
        this.chosenOption = this.chartOptions[this.chartType];
        var chart = document.querySelector('#selection-chart');
        chart.drawChart();
      },

      makeBar: function() {
        this.chartType = "column";
        this.chosenOption = this.chartOptions[this.chartType];
        var chart = document.querySelector('#selection-chart');
        chart.drawChart();
      },

      makeGeo: function() {
        this.chartType = "geo";
        this.chosenOption = this.chartOptions[this.chartType];
        var chart = document.querySelector('#selection-chart');
        chart.drawChart();
      },

      buildRef: function(baseRef) {
        return baseRef + this.firebaseNode //TODO: account for people not putting trailing or beginning slashes. Also, account for data coming from REST/API calls
      },

      buildChart: function() {  //Some Hardcoded information, need to change as soon as possible
        this.instRef = this.buildRef(this.baseRef);
        // this.firebaseNode = 'institutions'
        // this.instRef = this.buildRef(this.baseRef);
        // this.firebaseNode = 'expenditures'
        // this.expRef = this.buildRef(this.baseRef);
        this.chartData = this.data;
      }
    });
  })();
  </script>
</dom-module>
